---
title: 'AWS S3のオブジェクトを異なるAWSアカウントにコピーする'
date: '2022-06-13T00:00:00.000Z'
excerpt: 'S3のオブジェクトを異なるAWSアカウントにコピーする方法を調べました。'
tags: ['aws', 's3', 'iam', 'awscli']
published: true
---

# 何したん

AWS のアカウント A に存在する S3 オブジェクトをアカウント B にコピーする作業が発生しました。オブジェクトのコピーは AWS CLI の`aws s3 sync`を実行しましたが、その前にいろいろ対応が必要な作業がありましたので共有します。

# 実行環境

- aws-cli@2.4.18

# 対応方法

以下、A=AWS アカウント A、B=AWS アカウント B

## A コピー作業用の IAM ユーザーを作成

ユーザーの作成は AWS コンソール/AWS CLI などよしなに対応してください。（例. `s3-objects-copy-user`）
次にポリシーを作成します。コピー元バケットのオブジェクトを一覧表示したり、コピー先のバケットにオブジェクトをコピーしたりするのに必要なアクセス許可を設定します。（例. `s3-objects-copy-policy`）
最後に作成したポリシーを IAM ユーザーにアタッチします。

```json:s3-objects-copy-policy
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:GetObject"
            ],
            "Resource": [
                "arn:aws:s3:::<コピー元のバケット名>",
                "arn:aws:s3:::<コピー元のバケット名>/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:PutObject",
                "s3:PutObjectAcl"
            ],
            "Resource": [
                "arn:aws:s3:::<コピー先のバケット名>",
                "arn:aws:s3:::<コピー先のバケット名>/*"
            ]
        }
    ]
}
```

<!-- ![](https://storage.googleapis.com/zenn-user-upload/0fdd8971c08a-20220613.png) -->

<!-- ![](https://storage.googleapis.com/zenn-user-upload/628664786a5b-20220613.png) -->

## B バックアップ用の S3 バケットを作成

バケットの作成は AWS コンソール/AWS CLI などよしなに対応してください。（例. `s3-bucket-to`）
次にバックアップ用バケットのバケットポリシーを編集します。A の IAM ユーザーがコピー先のバケットにオブジェクトをコピーしたり、オブジェクトを一覧表示したりするのに最低限必要なアクセス許可を設定します。

```json:s3-bucket-toのバケットポリシー
{
    "Version": "2012-10-17",
    "Id": "Policy1611277539797",
    "Statement": [
        {
            "Sid": "Stmt1611277535086",
            "Effect": "Allow",
            "Principal": {
                "AWS": "<Aで作成したIAMユーザーのARN>"
            },
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::<コピー先のバケット名>/*",
            "Condition": {
                "StringEquals": {
                    "s3:x-amz-acl": "bucket-owner-full-control"
                }
            }
        },
        {
            "Sid": "Stmt1611277877767",
            "Effect": "Allow",
            "Principal": {
                "AWS": "<Aで作成したIAMユーザーのARN>"
            },
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::<コピー先のバケット名>"
        }
    ]
}
```

## AWS CLI でコマンドを実行

以下のコマンドを実行すると「コピー元バケットのディレクトリ以下のオブジェクト」が「コピー先バケットのディレクトリ」にコピーされます。コピー完了まで待機しましょう 🛌

```sh
aws s3 sync s3://<コピー元のバケット名>/<ディレクトリ> s3://<コピー先のバケット名>/<ディレクトリ> --acl bucket-owner-full-control
```

# 参考

https://aws.amazon.com/jp/premiumsupport/knowledge-center/copy-s3-objects-account/
